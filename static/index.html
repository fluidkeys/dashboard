<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="refresh" content="3600">
  <title>Fluidkeys Dashboard</title>
  <script src="/javascript/Chart.min.js"></script>
  <link rel="stylesheet" href="/stylesheets/main.css">
  <script>
    // A helper to format timestamp data
    Date.prototype.formatDDMM = function() {
      return this.getDate() +
      "/" + (this.getMonth() + 1)
    }

    document.addEventListener("DOMContentLoaded", function(){
      // create initial empty chart
      var responseSignUpCanvas = document.getElementById("responseSignUps");
      var responseSignUpChart = new Chart(responseSignUpCanvas, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            backgroundColor: 'rgb(255, 99, 132)',
            data: [],
          }]
        },
        options: {
          animation: false,
          maintainAspectRatio: false,
          legend: {
            display: false,
          },
          scales: {
            yAxes: [{
              ticks: {
                min: 0,
                max: 10,
                stepSize: 1
              }
            }]
          }
        }
      });

      getMetrics = function() {
        var request = new XMLHttpRequest();
        request.open('GET', '/json', true);
        request.onload = function() {
            if (request.status === 200) {
              var metrics = JSON.parse(request.responseText);

              var mostSignUpsInADay = 0;
              var mostUnSubscribesInADay = 0;
              metrics["releaseNotesSignups"].forEach(function(releaseNotesSignup) {
                responseSignUpChart.data.labels.push(new Date(releaseNotesSignup.date).formatDDMM());
                responseSignUpChart.data.datasets[0].data.push(parseFloat(releaseNotesSignup.count));
                if (releaseNotesSignup.count > mostSignUpsInADay) {
                  mostSignUpsInADay = releaseNotesSignup.count;
                }
                if (releaseNotesSignup.count < mostUnSubscribesInADay) {
                  mostUnSubscribesInADay = releaseNotesSignup.count;
                }
              });

              yAxesMax = Math.ceil(mostSignUpsInADay / 10) * 10;
              yAxesMin = Math.ceil(mostUnSubscribesInADay / 10) * 10;

              responseSignUpChart.options.scales.yAxes[0].ticks.max = yAxesMax;
              responseSignUpChart.options.scales.yAxes[0].ticks.min = yAxesMin;
              responseSignUpChart.update();

              if (metrics["callsArrangedNext7Days"] !== undefined) {
                callsArrangeCount = document.querySelector('#calls-arranged-next-week .count');
                callsArrangeCount.innerHTML = metrics["callsArrangedNext7Days"];
              }

              if (metrics["daysSinceLastRelease"] !== undefined) {
                daysSinceReleaseCount = document.querySelector('#days-since-last-release .count');
                daysSinceReleaseCount.innerHTML = metrics["daysSinceLastRelease"];
              }
            }
            else {
                alert('Request failed.  Returned status of ' + xhr.status);
            }
        };
        request.send();
      };

      
      
      getMetrics();
    });
  </script>
</head>
<body>
  <div id="dashboard">
    <div id="graph-container">
      <h2>Release note signups</h2>
      <div id="graph">
        <canvas id="responseSignUps"></canvas>
      </div>
    </div>
    <div id="big-numbers">
      <div id="calls-arranged-next-week" class="big-number">
        <span class="count">!</span>
        <span class="label">calls arranaged<br />next week</span>
      </div>
      <div id="days-since-last-release" class="big-number">
        <span class="count">!</span>
        <span class="label">days since<br />last release</span>
      </div>
    </div>
  </div>
</body>
</html>